<html lang="zh-TW"><head>
    <meta charset="UTF-8">
    <title>KS 批次兌換工具（多帳號 × 多禮包碼） </title>
    <style>
		.version-box {
		    position: fixed;
		    top: 10px;
		    right: 15px;
		    font-size: 12px;
		    color: #666;
		    text-align: right;
		    line-height: 1.5;
		    font-family: monospace;
		}
		
        body { font-family: Arial, "Noto Sans TC", sans-serif; padding: 20px; }
        textarea, input { width: 320px; height: 70px; padding: 8px; margin-bottom: 10px; }
        button { width: 250px; padding: 10px ; margin-top: 10px;}
        #log {
            white-space: pre-wrap;
            background: #111;
            color: #0f0;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            font-size: 13px;
		    margin-top: 20px;
		}
		.log-success { color: #00ff6a; }     /* 綠色 */
		.log-received { color: #aaaaaa; }    /* 灰色 */
		.log-error { color: #ff4d4d; }       /* 紅色 */
		.log-warning { color: #ffa500; }     /* 橘色 */
		.log-info { color: #0f0; }        /* 藍色 */

		.container {
		    display: flex;
		    gap: 10px;
		    align-items: flex-start;
		}
		
		.left-panel {
		    width: 400px;
		}
		
		.right-panel {
		    flex: 1;
		}
		
		.info-box {
		    border: 2px solid #7f7f7f;
		    padding: 20px;
		    border-radius: 8px;
		    background: #fffaf5;
		    color: #7f7f7f;
		    font-size: 12px;
		    line-height: 1;
		    box-shadow: 0 0 10px rgba(255,122,0,0.15);
			width: 500px;
		}
		
		.info-box h3 {
		    margin-top: 0;
		    color: #7f7f7f;
		}
		
		.info-box ul {
		    padding-left: 20px;
		    margin: 0;
		}
		
		.info-box li {
		    margin-bottom: 6px;
		}

    </style>
</head>
<body>
<div class="version-box">
    KS Redeemer Tool<br>
    Version: v2.1.1 (Single-Login Multi-Code)<br>
    Build: 2026-02-04<br>
    Mode: Github HTML
</div>
	
<h2>KingShots 批次兌換（多帳號 × 多禮包碼）</h2>
<div class="container">
    <div class="left-panel">
		<label>帳號 ID（每個ID請換行）</label><br>
		<textarea id="ids" rows="6" placeholder="例如：
12345678
23456789"></textarea><br>
		
		<label>禮包碼（每個禮包碼請換行）</label><br>
		<textarea id="codes" rows="6" placeholder="例如：
KS2024
VIP666"></textarea><br>
		
		<button id="start">開始批次兌換</button><br>
		<button id="clear">清除快取</button>
		<button id="fetchCodes" style="background-color: #ff7a00; color: white; border: none; cursor: pointer;">獲取最新禮包碼 (API)</button>
		Refer to: <a href="https://ks-rewards.com/" target="_blank">ks-rewards</a><br>
    </div>

    <div class="right-panel">
        <div class="info-box">
            <h3>狀態說明</h3>
            <ul>
                <li><b>SUCCESS</b>　成功兌換</li>
                <li><b>RECEIVED</b>　已經兌換過（已領取）</li>
                <li><b>TIME ERROR</b>　禮包碼過期</li>
                <li><b>USED</b>　禮包碼達領取上限</li>
                <li><b>INVALID</b>　禮包碼不存在 / 錯誤</li>
                <li><b>TIMEOUT RETRY</b>　伺服器要求重試</li>
				<li><b>CDK NOT FOUND</b>　禮包碼錯誤</li>
				<li><b>Login failed</b>　登入失敗 / 帳號不存在或錯誤</li>
            </ul>
        </div>
    </div>
</div>
	


<div id="log"></div>

<!-- MD5 -->
<script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.19.0/js/md5.min.js"></script>

<script>
    // 修正後的抓取函式
	async function fetchCodesFromSite() {
		try {
			log("從 API 嘗試抓取禮包碼...", "info");
			// 注意：如果你是在本地端執行，可能仍會遇到 CORS 問題
			const res = await fetch("https://ks-rewards.com/api/codes");
			
			if (!res.ok) throw new Error(`連線失敗 (${res.status})`);
			
			const data = await res.json();
			
			// 修正過濾邏輯：匹配 validation_status 為 "validated"
			const codes = data.codes
				.filter(item => item.validation_status === "validated") // 修正這裡
				.map(item => item.code);

			if (codes.length > 0) {
				log(`成功抓到 ${codes.length} 個有效禮包碼：${codes.join(", ")}`, "success");
				return codes;
			} else {
				log("API 內目前沒有狀態為 'validated' 的禮包碼", "warning");
				return [];
			}
		} catch (err) {
			log("抓取失敗：" + err.message, "error");
			return [];
		}
	}

    // 綁定按鈕事件
    document.getElementById("fetchCodes").addEventListener("click", async () => {
        const codes = await fetchCodesFromSite();
        if (codes.length > 0) {
            // 將代碼以換行方式填入 textarea
            document.getElementById("codes").value = codes.join("\n");
        }
    });

    // 原有的啟動時自動抓取 (修正邏輯)
    window.addEventListener("load", async () => {
        // 延遲兩秒自動嘗試抓取一次
        setTimeout(async () => {
            const savedCodes = localStorage.getItem("ks_codes");
            // 如果原本沒資料，才自動抓取
            if (!savedCodes) {
                const codes = await fetchCodesFromSite();
                if (codes.length > 0) {
                    document.getElementById("codes").value = codes.join("\n");
                }
            }
        }, 2000);
    });
</script>
	
<script> 
	window.addEventListener("DOMContentLoaded", () => {
	    const savedIds = localStorage.getItem("ks_ids");
	    const savedCodes = localStorage.getItem("ks_codes");
	
	    if (savedIds) {
	        document.getElementById("ids").value = savedIds;
	    }
	
	    if (savedCodes) {
	        document.getElementById("codes").value = savedCodes;
	    }
	});
</script>
<script>
const LOGIN_URL = "https://kingshot-giftcode.centurygame.com/api/player";
const REDEEM_URL = "https://kingshot-giftcode.centurygame.com/api/gift_code";
const SECRET = "mN4!pQs6JrYwV9";
const DELAY = 2000; // 2 秒

const logBox = document.getElementById("log");
const delay = ms => new Promise(r => setTimeout(r, ms));

/*
function log(msg) {
    const time = new Date().toLocaleTimeString();
    logBox.textContent += `[${time}] ${msg}\n`;
    logBox.scrollTop = logBox.scrollHeight;
}
*/
function log(msg, type = "info") {
    const time = new Date().toLocaleTimeString();

    let className = "log-info";
    if (type === "success") className = "log-success";
    if (type === "received") className = "log-received";
    if (type === "error") className = "log-error";
    if (type === "warning") className = "log-warning";

    logBox.innerHTML += `<div class="${className}">[${time}] ${msg}</div>`;
    logBox.scrollTop = logBox.scrollHeight;
}

/* 對齊 Python encode_data */
function encodeData(data) {
    const sortedKeys = Object.keys(data).sort();
    const encoded = sortedKeys.map(key => {
        const val = typeof data[key] === "object" ? JSON.stringify(data[key]) : data[key];
        return `${key}=${val}`;
    }).join("&");

    const sign = md5(encoded + SECRET);
    return { sign, ...data };
}

async function makeRequest(url, payload) {
    const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    });

    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return res.json();
}

async function redeemGiftCode(fid, cdk) {
    if (!/^\d+$/.test(fid)) {
        return { msg: "Invalid FID format" };
    }

    // === Login ===
    const loginPayload = encodeData({
        fid: fid,
        time: Date.now()
    });

    const loginData = await makeRequest(LOGIN_URL, loginPayload);

    if (loginData.code !== 0) {
        return { msg: `Login failed: ${loginData.msg || "Unknown error"}` };
    }

    const nickname = loginData.data?.nickname || "Unknown";
    log(`登入成功：${nickname} (${fid})`);

    await delay(500);

    // === Redeem ===
    const redeemPayload = encodeData({
        fid: fid,
        cdk: cdk,
        time: Date.now()
    });

    const redeemData = await makeRequest(REDEEM_URL, redeemPayload);
    return redeemData;
}

/*清除快取*/
document.getElementById("clear").addEventListener("click", () => {
    localStorage.removeItem("ks_ids");
    localStorage.removeItem("ks_codes");
    document.getElementById("ids").value = "";
    document.getElementById("codes").value = "";
    //alert("已清除儲存的帳號與禮包碼");
	//log(`→ 已清除儲存的帳號與禮包碼`);
	logBox.innerHTML += `<div class="log-error">→ 已清除儲存的帳號與禮包碼</div>`;
});

	
/* ====== 主流程：多帳號 × 多禮包碼 ====== */
document.getElementById("start").addEventListener("click", async () => {
    const idsRaw = document.getElementById("ids").value.trim();
    const codesRaw = document.getElementById("codes").value.trim();
    // === 儲存到 localStorage ===
    localStorage.setItem("ks_ids", idsRaw);
    localStorage.setItem("ks_codes", codesRaw);

    if (!idsRaw || !codesRaw) {
        //alert("請輸入帳號 ID 與 禮包碼");
		//log(`→ 請輸入帳號 ID 與 禮包碼`);
		logBox.innerHTML += `<div class="log-error">→ 請輸入帳號 ID 與 禮包碼</div>`;
        return
    }

    const ids = idsRaw.split(/[\n,]+/).map(i => i.trim()).filter(Boolean);
    const codes = codesRaw.split(/[\n,]+/).map(c => c.trim()).filter(Boolean);

    log("=== 開始批次兌換（多帳號 × 多禮包碼） ===");


	//主程式
	/*test
    for (const fid of ids) {
        log(`\n====== 處理帳號 ${fid} ======`);

        for (const code of codes) {
            log(`→ 兌換禮包碼：${code}`);

            try {
                const result = await redeemGiftCode(fid, code);
                //log(`結果：${result.msg || JSON.stringify(result)}`);
				const msg = result.msg || "";

				if (msg.includes("SUCCESS")) {
				    log(`結果：${msg}`, "success");
				} else if (msg.includes("RECEIVED")) {
				    log(`結果：${msg}`, "received");
				} else if (msg.includes("TIME ERROR") || msg.includes("USED") || msg.includes("Login failed")) {
				    log(`結果：${msg}`, "error");
				} else if (msg.includes("TIMEOUT") || msg.includes("CDK")) {
				    log(`結果：${msg}`, "warning");
				} else {
				    log(`結果：${msg}`, "info");
				}

            } catch (e) {
                log(`錯誤：${e.message}`);
            }

            log(`等待 ${DELAY/1000} 秒...\n`);
            await delay(DELAY);
        }
    }

	test*/

	for (const fid of ids) {
    log(`\n====== 處理帳號 ${fid} ======`);

    // === 只登入一次 ===
    const loginPayload = encodeData({
        fid: fid,
        time: Date.now()
    });

    try {
        const loginData = await makeRequest(LOGIN_URL, loginPayload);

        if (loginData.code !== 0) {
            log(`登入失敗：${loginData.msg}`, "error");
            continue; // 這個帳號跳過
        }

        const nickname = loginData.data?.nickname || "Unknown";
        log(`登入成功：${nickname} (${fid})`, "success");

    } catch (e) {
        log(`登入錯誤：${e.message}`, "error");
        continue;
    }

    // === 登入成功後，開始兌換所有 code ===
    for (const code of codes) {
        log(`→ 兌換禮包碼：${code}`, "info");

        try {
            const redeemPayload = encodeData({
                fid: fid,
                cdk: code,
                time: Date.now()
            });

            const result = await makeRequest(REDEEM_URL, redeemPayload);
            const msg = result.msg || "";

            if (msg.includes("SUCCESS") || msg.includes("SAME TYPE EXCHANGE")) {
                log(`結果：${msg}`, "success");
            } else if (msg.includes("RECEIVED")) {
                log(`結果：${msg}`, "received");
            } else if (msg.includes("TIME ERROR") || msg.includes("USED")) {
                log(`結果：${msg}`, "error");
            } else {
                log(`結果：${msg}`, "warning");
            }

        } catch (e) {
            log(`兌換錯誤：${e.message}`, "error");
        }

        await delay(DELAY); // 每個禮包碼之間延遲
    }
}

    log("=== 全部帳號 × 禮包碼 處理完成 ===");
});
</script>



</body></html>
