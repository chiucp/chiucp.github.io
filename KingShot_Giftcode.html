<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>KS 自動兌換工具（單檔版）</title>
    <style>
        body { font-family: Arial, "Noto Sans TC", sans-serif; padding: 20px; }
        textarea, input { width: 300px; padding: 8px; margin-bottom: 10px; }
        button { padding: 10px 20px; }
        #log { white-space: pre-wrap; background: #111; color: #0f0; padding: 10px; height: 300px; overflow-y: auto; }
    </style>
</head>
<body>

<h2>KS 自動兌換（單一 HTML 版）</h2>

<textarea id="ids" rows="6" placeholder="一行一個 FID"></textarea><br>
<input id="code" placeholder="輸入禮包碼"><br>
<button id="start">開始兌換</button>

<div id="log"></div>

<!-- MD5 函式庫 -->
<script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.19.0/js/md5.min.js"></script>

<script>
/* ====== 直接對齊你 Python 的設定 ====== */
const LOGIN_URL = "https://kingshot-giftcode.centurygame.com/api/player";
const REDEEM_URL = "https://kingshot-giftcode.centurygame.com/api/gift_code";
const SECRET = "mN4!pQs6JrYwV9";
const DELAY = 2000; // 2 秒

const logBox = document.getElementById("log");
const delay = ms => new Promise(r => setTimeout(r, ms));

function log(msg) {
    const time = new Date().toLocaleTimeString();
    logBox.textContent += `[${time}] ${msg}\n`;
    logBox.scrollTop = logBox.scrollHeight;
}

/* ====== 完整對齊 Python 的 encode_data ====== */
function encodeData(data) {
    const sortedKeys = Object.keys(data).sort();
    const encoded = sortedKeys.map(key => {
        const val = typeof data[key] === "object" ? JSON.stringify(data[key]) : data[key];
        return `${key}=${val}`;
    }).join("&");

    const sign = md5(encoded + SECRET);
    return { sign, ...data };
}

/* ====== 發送請求（對齊 requests.post(json=payload)） ====== */
async function makeRequest(url, payload) {
    const res = await fetch(url, {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
    });

    if (!res.ok) {
        throw new Error(`HTTP ${res.status}`);
    }

    return res.json();
}

/* ====== 完整對齊 Python 的 redeem_gift_code ====== */
async function redeemGiftCode(fid, cdk) {
    if (!/^\d+$/.test(fid)) {
        return { msg: "Invalid FID format" };
    }

    const now = Date.now();

    // === Login ===
    const loginPayload = encodeData({
        fid: fid,
        time: now
    });

    const loginData = await makeRequest(LOGIN_URL, loginPayload);

    if (loginData.code !== 0) {
        return { msg: `Login failed: ${loginData.msg || "Unknown error"}` };
    }

    const nickname = loginData.data?.nickname || "Unknown";
    log(`登入成功：${nickname} (${fid})`);

    await delay(500); // 模擬 Python 中間的節奏

    // === Redeem ===
    const redeemPayload = encodeData({
        fid: fid,
        cdk: cdk,
        time: Date.now()
    });

    const redeemData = await makeRequest(REDEEM_URL, redeemPayload);
    return redeemData;
}

/* ====== 主流程 ====== */
document.getElementById("start").addEventListener("click", async () => {
    const idsRaw = document.getElementById("ids").value.trim();
    const code = document.getElementById("code").value.trim();

    if (!idsRaw || !code) {
        alert("請輸入 FID 與 禮包碼");
        return;
    }

    const ids = idsRaw.split(/[\n,]+/).map(i => i.trim()).filter(Boolean);

    log("=== 開始兌換 ===");

    for (const fid of ids) {
        log(`處理 ${fid} ...`);

        try {
            const result = await redeemGiftCode(fid, code);
            log(`結果：${result.msg || JSON.stringify(result)}`);
        } catch (e) {
            log(`錯誤：${e.message}`);
        }

        log(`等待 ${DELAY/1000} 秒...\n`);
        await delay(DELAY);
    }

    log("=== 全部完成 ===");
});
</script>

</body>
</html>
