<html lang="zh-TW"><head>
    <meta charset="UTF-8">
    <title>KS 批次兌換工具（多帳號 × 多禮包碼）</title>
    <style>
        body { font-family: Arial, "Noto Sans TC", sans-serif; padding: 20px; }
        textarea, input { width: 320px; height: 70px; padding: 5px; margin-bottom: 10px; }
        button { padding: 10px 100px; }
        #log {
            white-space: pre-wrap;
            background: #111;
            color: #0f0;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            font-size: 13px;
		    margin-top: 20px;          
	}
    </style>
</head>
<body>

<h2>KingShots 批次兌換（多帳號 × 多禮包碼）</h2>

<label>帳號 ID（每個ID請換行）</label><br>
<textarea id="ids" rows="6" placeholder="例如：
12345678
23456789"></textarea><br>

<label>禮包碼（每個禮包碼請換行）</label><br>
<textarea id="codes" rows="6" placeholder="例如：
KS2024
WELCOME
VIP666"></textarea><br>

<button id="start">開始批次兌換</button><br>

<div id="log"></div>

<!-- MD5 -->
<script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.19.0/js/md5.min.js"></script>

<script>
const LOGIN_URL = "https://kingshot-giftcode.centurygame.com/api/player";
const REDEEM_URL = "https://kingshot-giftcode.centurygame.com/api/gift_code";
const SECRET = "mN4!pQs6JrYwV9";
const DELAY = 2000; // 2 秒

const logBox = document.getElementById("log");
const delay = ms => new Promise(r => setTimeout(r, ms));

function log(msg) {
    const time = new Date().toLocaleTimeString();
    logBox.textContent += `[${time}] ${msg}\n`;
    logBox.scrollTop = logBox.scrollHeight;
}

/* 對齊 Python encode_data */
function encodeData(data) {
    const sortedKeys = Object.keys(data).sort();
    const encoded = sortedKeys.map(key => {
        const val = typeof data[key] === "object" ? JSON.stringify(data[key]) : data[key];
        return `${key}=${val}`;
    }).join("&");

    const sign = md5(encoded + SECRET);
    return { sign, ...data };
}

async function makeRequest(url, payload) {
    const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    });

    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return res.json();
}

async function redeemGiftCode(fid, cdk) {
    if (!/^\d+$/.test(fid)) {
        return { msg: "Invalid FID format" };
    }

    // === Login ===
    const loginPayload = encodeData({
        fid: fid,
        time: Date.now()
    });

    const loginData = await makeRequest(LOGIN_URL, loginPayload);

    if (loginData.code !== 0) {
        return { msg: `Login failed: ${loginData.msg || "Unknown error"}` };
    }

    const nickname = loginData.data?.nickname || "Unknown";
    log(`登入成功：${nickname} (${fid})`);

    await delay(500);

    // === Redeem ===
    const redeemPayload = encodeData({
        fid: fid,
        cdk: cdk,
        time: Date.now()
    });

    const redeemData = await makeRequest(REDEEM_URL, redeemPayload);
    return redeemData;
}

/* ====== 主流程：多帳號 × 多禮包碼 ====== */
document.getElementById("start").addEventListener("click", async () => {
    const idsRaw = document.getElementById("ids").value.trim();
    const codesRaw = document.getElementById("codes").value.trim();

    if (!idsRaw || !codesRaw) {
        alert("請輸入帳號 FID 與 禮包碼");
        return;
    }

    const ids = idsRaw.split(/[\n,]+/).map(i => i.trim()).filter(Boolean);
    const codes = codesRaw.split(/[\n,]+/).map(c => c.trim()).filter(Boolean);

    log("=== 開始批次兌換（多帳號 × 多禮包碼） ===");

    for (const fid of ids) {
        log(`\n====== 處理帳號 ${fid} ======`);

        for (const code of codes) {
            log(`→ 兌換禮包碼：${code}`);

            try {
                const result = await redeemGiftCode(fid, code);
                log(`結果：${result.msg || JSON.stringify(result)}`);
            } catch (e) {
                log(`錯誤：${e.message}`);
            }

            log(`等待 ${DELAY/1000} 秒...\n`);
            await delay(DELAY);
        }
    }

    log("=== 全部帳號 × 禮包碼 處理完成 ===");
});
</script>



</body></html>
