<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自動兌換程式</title>
    <style>
        body { font-family: Arial, 'Noto Sans TC', sans-serif; margin: 20px; }
        .input-group { margin-bottom: 10px; }
        label { display: block; margin-bottom: 5px; }
        input, textarea { width: 300px; padding: 8px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }
        #status { margin-top: 20px; color: green; }
    </style>
</head>
<body>
    <h1>遊戲兌換碼自動兌換</h1>
    
    <div class="input-group">
        <label for="ids">輸入框 A：帳號 ID（每行一個或以逗號分隔）</label>
        <textarea id="ids" rows="5" placeholder="輸入多個 ID，例如：ID1,ID2 或每行一個"></textarea>
    </div>
    
    <div class="input-group">
        <label for="code">輸入框 B：兌換碼</label>
        <input type="text" id="code" placeholder="輸入兌換碼">
    </div>
    
    <button id="redeemBtn">為所有帳號兌換</button>
    
    <div id="status"></div>

<script>
    // 延遲工具函數
    function delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    // 載入儲存的 ID
    window.onload = function() {
        const savedIds = localStorage.getItem('accountIds');
        if (savedIds) {
            document.getElementById('ids').value = savedIds;
        }
    };

    document.getElementById('redeemBtn').addEventListener('click', async () => {
        const idsInput = document.getElementById('ids').value.trim();
        const code = document.getElementById('code').value.trim();
        const statusDiv = document.getElementById('status');

        if (!idsInput || !code) {
            statusDiv.innerHTML = '<span style="color:red">請輸入帳號 ID 和兌換碼。</span>';
            return;
        }

        // 儲存 ID 到 localStorage
        localStorage.setItem('accountIds', idsInput);

        // 分割 ID（支援逗號或換行）
        const ids = idsInput.split(/[\n,]+/).map(id => id.trim()).filter(id => id);

        statusDiv.innerHTML = '開始處理中...<br>';

        for (const id of ids) {
            statusDiv.innerHTML += `<br><strong>處理 ID: ${id}</strong><br>`;

            try {
                // 步驟1：模擬/真實登入或驗證玩家ID是否存在
                const loginResponse = await simulateLogin(id);
                statusDiv.innerHTML += `登入/驗證回應: ${JSON.stringify(loginResponse)}<br>`;

                await delay(1200);  // 登入後等 1.2 秒再兌換（模擬真人）

                // 步驟2：兌換
                const redeemResponse = await simulateRedeem(id, code);
                const msg = redeemResponse.message || redeemResponse.msg || '兌換成功';

                if (redeemResponse.success || redeemResponse.code === 0) {  // 根據實際回應調整判斷
                    statusDiv.innerHTML += `<span style="color:green">ID ${id}: ${msg}</span><br>`;
                } else {
                    statusDiv.innerHTML += `<span style="color:orange">ID ${id}: ${msg || '兌換失敗'}</span><br>`;
                }
            } catch (error) {
                statusDiv.innerHTML += `<span style="color:red">ID ${id}: 錯誤 - ${error.message}</span><br>`;
            }

            await delay(2500);  // 每筆帳號處理完，等 2.5 秒再處理下一筆（最重要防 ban）
        }

        statusDiv.innerHTML += '<br><strong style="color:blue">全部帳號處理完成！</strong>';
    });

    // 登入/驗證玩家（請根據真實 Network 請求調整）
    async function simulateLogin(id) {
        try {
            const response = await fetch('https://ks-giftcode.centurygame.com/api/player', {  // 確認這是不是正確端點
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json' 
                    // 如果是 form-urlencoded，改成 'application/x-www-form-urlencoded'
                    // 可能需要額外 header 如 'User-Agent', 'Referer' 等
                },
                body: JSON.stringify({ playerId: id })  // 實際可能用 fid= 或其他欄位
                // 如果是 form data： new URLSearchParams({ fid: id, time: Date.now(), sign: '計算出來的sign' })
            });

            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return await response.json();
        } catch (err) {
            throw err;
        }
    }

    // 兌換函數（同樣請調整成真實請求）
    async function simulateRedeem(id, code) {
        try {
            const response = await fetch('https://ks-giftcode.centurygame.com/api/gift_code', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ playerId: id, giftCode: code })
            });

            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return await response.json();
        } catch (err) {
            throw err;
        }
    }
</script>
</body>
</html>
